//- pages/stats.pug
extends layout

block content

  .container
    include partials/_sec-nav

    .row
      .col-sm-12
        h2 Визуализация подкаста

        .stats-overview.mt-5
          .row
            .col-6.col-md-3.col-sm-6.mb-4
              .stat-box.rounded-circle.d-flex.flex-column.justify-content-center.align-items-center
                .stat-number.display-4 #{listeners}
                .stat-label.text-center слушателей
            .col-6.col-md-3.col-sm-6.mb-4
              .stat-box.rounded-circle.d-flex.flex-column.justify-content-center.align-items-center
                .stat-number.display-4 #{totalHours}
                .stat-label.text-center часов аудио
            .col-6.col-md-3.col-sm-6.mb-4
              .stat-box.rounded-circle.d-flex.flex-column.justify-content-center.align-items-center
                .stat-number.display-4 #{countries}
                .stat-label.text-center стран, где записывали
            .col-6.col-md-3.col-sm-6.mb-4
              .stat-box.rounded-circle.d-flex.flex-column.justify-content-center.align-items-center
                .stat-number.display-4 #{guests}
                .stat-label.text-center гостей

        .mb-4
          h3.mb-4 По годам

          .episodes-by-year
            each episodes, year in episodesByYear
              .year-row.d-flex
                .year-label.mr-3.pt-1 #{year}
                .episode-blocks
                  each episode in episodesByYear[year]
                    a.episode-block(
                      data-episode-num=episode.episodeNum
                      data-title=episode.title
                      data-date=episode.pubDateConverted
                      data-duration=episode.duration
                      href=`/episodes/${episode.episodeNum}`)= episode.title

        .mb-4
          h3.text-white.mb-4 Источники слушателей

        .row
          each source in audienceSummary
            .col  
              h4.mb-2= source.sourceName
              each yearSummary in source.yearSummaries
                p #{yearSummary.year}: #{yearSummary.totalPlays} plays

  include partials/footer

  include partials/_player

  script.
    document.addEventListener('DOMContentLoaded', function() {
      const episodeBlocks = document.querySelectorAll('.episode-block');

      function formatDuration(duration) {
        const parts = duration.split(':');
        if (parts.length === 2) {
          return `${parts[0]}:${parts[1]}`;
        } else if (parts.length === 3) {
          return `${parts[0]}:${parts[1]}:${parts[2]}`;
        }
        return duration;
      }

      episodeBlocks.forEach(block => {
        const tooltip = document.createElement('div');
        tooltip.className = 'episode-tooltip';
        tooltip.innerHTML = `
          <h4><b>${block.dataset.title}</b></h4>
          <p>Дата: <b>${block.dataset.date}</b></p>
          <p>Длительность: <b>${formatDuration(block.dataset.duration)}</b></p>
        `;
        block.appendChild(tooltip);

        block.addEventListener('mouseenter', () => {
          tooltip.style.display = 'block';
        });

        block.addEventListener('mouseleave', () => {
          tooltip.style.display = 'none';
        });
      });
    });