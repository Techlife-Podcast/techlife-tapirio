name: Test SSH Connection
on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  test-ssh:
    runs-on: ubuntu-latest
    steps:
    - name: Debug SSH key
      run: |
        if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "SSH_PRIVATE_KEY is set"
          echo "Length of SSH_PRIVATE_KEY: $(echo "${{ secrets.SSH_PRIVATE_KEY }}" | wc -c) characters"
          echo "First few characters of SSH_PRIVATE_KEY: $(echo "${{ secrets.SSH_PRIVATE_KEY }}" | cut -c 1-10)..."
          echo "Does it start with '-----BEGIN'?: $(echo "${{ secrets.SSH_PRIVATE_KEY }}" | grep -q '^-----BEGIN' && echo "Yes" || echo "No")"
        else
          echo "SSH_PRIVATE_KEY is not set"
        fi

    - name: Set up SSH key
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub
        echo "Public key generated from private key:"
        cat ~/.ssh/id_rsa.pub

    - name: Test SSH connection
      run: |
        ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -vvv ${{ secrets.USERNAME }}@${{ secrets.HOST }} "echo 'SSH connection successful'"